model_version: "1.0"
extension:
  id: dev.kiket.ext.mailjet-inbound
  name: Mailjet Inbound
  version: 1.1.0
  description: Process inbound emails from Mailjet Parse API and create issues or comments
  author: Kiket Team
  homepage: https://github.com/kiket-dev/kiket-ext-mailjet-inbound
  sdk: ruby
  delivery: http
  callback:
    url: ${EXTENSION_BASE_URL}
    secret: env.KIKET_WEBHOOK_SECRET
    timeout: 30000
    required: true
  activationEvents:
    - external.webhook.inbound_email
  permissions:
    - issues:write
    - comments:write
    - users:read
  capabilities:
    - email-to-issue
    - external-webhook
  hooks:
    - event: external.webhook.inbound_email
      timeout: 30000
      retries: 2
      description: Process inbound email from Mailjet via External Webhook Routing
  configuration:
    default_project_id:
      type: project
      label: Default Project
      description: Project where new issues will be created from emails
    default_issue_type:
      type: issue_type
      default: "Task"
      label: Default Issue Type
      description: Issue type for new issues created from emails
    create_from_unknown_senders:
      type: boolean
      default: "false"
      label: Accept Unknown Senders
      description: Create issues from emails sent by non-registered users
  secrets:
    - key: MAILJET_WEBHOOK_TOKEN
      label: Mailjet Webhook Token
      description: Optional token for verifying webhooks from Mailjet
      required: false
  setup:
    - configure:
        title: Configure Email Processing
        description: Set up how inbound emails are processed
        fields:
          - key: default_project_id
            type: project
            label: Default Project
            description: Project where new issues will be created
            required: true
          - key: default_issue_type
            type: issue_type
            label: Default Issue Type
            description: Issue type to create from incoming emails (options from your workflow definition)
            default: Task
          - key: create_from_unknown_senders
            type: boolean
            label: Accept Unknown Senders
            default: false
    - info:
        title: Setup Complete
        content: |
          ## Mailjet Webhook Configuration

          Configure your Mailjet Parse API to forward emails to your Kiket webhook URL.

          ### Step 1: Get Your Webhook URL

          Your webhook URL is shown in **Project Settings** → **Extensions** → **Mailjet Inbound** → **Configure**.

          Copy the **External Webhook URL** displayed in the sidebar.

          ### Step 2: Configure Mailjet Parse API

          The Parse API is configured via Mailjet's REST API (requires Crystal plan or above).

          Get your API credentials from **Mailjet Dashboard** → **Account Settings** → **API Key Management**.

          Create a parse route:
          ```bash
          curl -X POST \
            --user "$MJ_API_KEY:$MJ_SECRET_KEY" \
            https://api.mailjet.com/v3/REST/parseroute \
            -H "Content-Type: application/json" \
            -d '{"Url": "YOUR_WEBHOOK_URL", "Email": "incoming@inbound.kiket.dev"}' | jq .
          ```

          ### Step 3: Add DNS MX Record

          Add an MX record for your inbound domain:
          ```
          inbound.kiket.dev.  MX  10  parse.mailjet.com.
          ```

          See the [Mailjet Parse API documentation](https://dev.mailjet.com/email/guides/parse-api/) for more details.
        links:
          - label: Mailjet Parse API Docs
            url: https://dev.mailjet.com/email/guides/parse-api/
            icon: book
          - label: External Webhook Routing Docs
            url: https://docs.kiket.dev/extensions/external-webhook-routing
            icon: link
  assets:
    icon: ./public/icon.svg
  hosting: internal
