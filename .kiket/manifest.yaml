model_version: "1.0"
extension:
  id: dev.kiket.ext.mailjet-inbound
  name: Mailjet Inbound
  version: 1.2.0
  description: Process inbound emails from Mailjet Parse API and create issues or comments
  author: Kiket Team
  homepage: https://github.com/kiket-dev/kiket-ext-mailjet-inbound
  sdk: ruby
  delivery: http
  callback:
    url: ${EXTENSION_BASE_URL}
    secret: env.KIKET_WEBHOOK_SECRET
    timeout: 30000
    required: true
  activationEvents:
    - external.webhook.inbound_email
  permissions:
    - issues:write
    - comments:write
    - users:read
  capabilities:
    - email-to-issue
    - external-webhook
  hooks:
    - event: external.webhook.inbound_email
      timeout: 30000
      retries: 2
      description: Process inbound email from Mailjet via External Webhook Routing
  configuration:
    default_project_id:
      type: project
      label: Default Project
      description: Project where new issues will be created from emails
    default_issue_type:
      type: issue_type
      default: "Task"
      label: Default Issue Type
      description: Issue type for new issues created from emails
    create_from_unknown_senders:
      type: boolean
      default: "false"
      label: Accept Unknown Senders
      description: Create issues from emails sent by non-registered users
    mailjet_inbound_email:
      type: text
      label: Mailjet Inbound Email
      description: The email address configured in Mailjet (set automatically during setup)
      readonly: true
  secrets:
    - key: MAILJET_API_KEY
      label: Mailjet API Key
      description: Your Mailjet API key (from Account Settings → API Key Management)
      required: true
    - key: MAILJET_SECRET_KEY
      label: Mailjet Secret Key
      description: Your Mailjet Secret key
      required: true
    - key: MAILJET_WEBHOOK_TOKEN
      label: Mailjet Webhook Token
      description: Optional token for additional webhook verification
      required: false
  setup:
    # Step 1: Mailjet API Credentials
    - secrets:
        title: Mailjet API Credentials
        description: |
          Enter your Mailjet API credentials to enable automatic setup.

          **Note:** Parse API requires a paid Mailjet plan (Crystal or above).

          Find your credentials at [Mailjet Dashboard](https://app.mailjet.com) → **Account Settings** → **API Key Management**.
        fields:
          - key: MAILJET_API_KEY
            label: API Key
            required: true
          - key: MAILJET_SECRET_KEY
            label: Secret Key
            required: true

    # Step 2: Email Processing Configuration
    - configure:
        title: Configure Email Processing
        description: Set up how inbound emails are processed
        fields:
          - key: default_project_id
            type: project
            label: Default Project
            description: Project where new issues will be created
            required: true
          - key: default_issue_type
            type: issue_type
            label: Default Issue Type
            description: Issue type to create from incoming emails
            default: Task
          - key: create_from_unknown_senders
            type: boolean
            label: Accept Unknown Senders
            default: false

    # Step 3: Connect to Mailjet
    - test:
        title: Connect to Mailjet
        description: |
          Click the button below to automatically configure Mailjet Parse API.

          This will create a parse route in your Mailjet account that forwards
          inbound emails to Kiket.
        action: mailjet.connectParseApi
        successMessage: Successfully connected to Mailjet! Your parse route is configured.
        required: true

    # Step 4: DNS Setup Instructions
    - info:
        title: Final Step - DNS Configuration
        content: |
          ## DNS Setup Required

          Your Mailjet Parse API is now configured. The final step is to set up DNS
          so that emails are routed to Mailjet.

          ### Add MX Record

          Add an MX record for your inbound email domain:

          ```
          inbound.yourdomain.com.  MX  10  parse.mailjet.com.
          ```

          Replace `inbound.yourdomain.com` with your actual inbound domain.

          ### Verify DNS Propagation

          ```bash
          dig MX inbound.yourdomain.com +short
          # Expected: 10 parse.mailjet.com.
          ```

          DNS changes may take up to 48 hours to propagate.

          ### Your Inbound Email Address

          Once DNS is configured, emails sent to your configured address will
          automatically create issues in Kiket.
        links:
          - label: Mailjet Parse API Docs
            url: https://dev.mailjet.com/email/guides/parse-api/
            icon: book
          - label: DNS Checker
            url: https://dnschecker.org/
            icon: link
  assets:
    icon: ./public/icon.svg
  hosting: internal
